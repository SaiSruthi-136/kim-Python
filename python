class Solution:
    def maxProfit(self, prices, strategy, k):
        n = len(prices)

        # Base profit
        baseProfit = sum(strategy[i] * prices[i] for i in range(n))

        # Prefix arrays
        prefA = [0] * (n + 1)
        prefB = [0] * (n + 1)

        for i in range(n):
            A = strategy[i] * prices[i]
            B = prices[i] - A
            prefA[i + 1] = prefA[i] + A
            prefB[i + 1] = prefB[i] + B

        half = k // 2
        maxGain = 0

        for l in range(n - k + 1):
            firstSum = prefA[l + half] - prefA[l]
            secondSum = prefB[l + k] - prefB[l + half]
            gain = -firstSum + secondSum
            maxGain = max(maxGain, gain)

        return baseProfit + maxGain
