from collections import defaultdict

class Solution(object):
    def pyramidTransition(self, bottom, allowed):
        trans = defaultdict(list)
        for a in allowed:
            trans[(a[0], a[1])].append(a[2])

        memo = {}

        def dfs(row):
            if row in memo:
                return memo[row]

            if len(row) == 1:
                return True

            def build_next(i, cur):
                if i == len(row) - 1:
                    return dfs(cur)

                key = (row[i], row[i + 1])
                if key not in trans:
                    return False

                for c in trans[key]:
                    if build_next(i + 1, cur + c):
                        return True
                return False

            memo[row] = build_next(0, "")
            return memo[row]

        return dfs(bottom)
